<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Little Secret Online - Firebase</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 500px; margin: auto; padding: 10px; }
    input, button { font-size: 1em; padding: 8px; margin: 5px 0; width: 100%; }
    #gameSection { display: none; }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
</head>
<body>

<h1>Little Secret Online</h1>

<div id="loginSection">
  <p>Wpisz swój nick, aby się zalogować anonimowo:</p>
  <input type="text" id="nickInput" placeholder="Twój nick" />
  <button onclick="login()">Zaloguj się</button>
</div>

<div id="lobbySection" style="display:none;">
  <h2>Witaj, <span id="playerNick"></span>!</h2>

  <button onclick="createNewRoom()">Utwórz nowy pokój</button>
  
  <p>LUB</p>

  <input type="text" id="roomIdInput" placeholder="Wpisz ID pokoju" />
  <button onclick="joinExistingRoom()">Dołącz do pokoju</button>
</div>

<div id="gameSection">
  <h2>Pokój: <span id="roomIdDisplay"></span></h2>
  <p>Liczba graczy: <span id="playersCount">0</span></p>
  <ul id="playersList"></ul>

  <button id="startGameBtn" onclick="startGame()" style="display:none;">Start gry (tylko host)</button>

  <p id="wordDisplay" style="font-weight:bold; font-size:1.2em; margin-top:20px;"></p>
</div>

<script>
  // -- TU Wklej konfigurację z Firebase --
  const firebaseConfig = {
    apiKey: "TU_WKLEJ",
    authDomain: "TU_WKLEJ",
    projectId: "TU_WKLEJ",
    storageBucket: "TU_WKLEJ",
    messagingSenderId: "TU_WKLEJ",
    appId: "TU_WKLEJ"
  };

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUser = null;
  let currentRoomId = null;
  let isHost = false;

  // Logowanie anonimowe z nickiem
  async function login() {
    const nick = document.getElementById('nickInput').value.trim();
    if (!nick) return alert('Wpisz swój nick');

    try {
      const userCredential = await auth.signInAnonymously();
      currentUser = userCredential.user;

      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('lobbySection').style.display = 'block';
      document.getElementById('playerNick').textContent = nick;

      currentUser.nick = nick; // zapisz nick lokalnie

    } catch (error) {
      alert('Błąd logowania: ' + error.message);
    }
  }

  // Generowanie kodu pokoju (6 liter i cyfr)
  function generateRoomId() {
    return Math.random().toString(36).substring(2, 8).toUpperCase();
  }

  // Tworzenie pokoju
  async function createNewRoom() {
    if (!currentUser) return alert('Zaloguj się najpierw');

    const roomId = generateRoomId();
    currentRoomId = roomId;
    isHost = true;

    const roomRef = db.collection('rooms').doc(roomId);
    await roomRef.set({
      started: false,
      createdAt: Date.now(),
      hostUid: currentUser.uid
    });

    await roomRef.collection('players').doc(currentUser.uid).set({
      nick: currentUser.nick,
      joinedAt: Date.now()
    });

    openRoom(roomId);
  }

  // Dołączanie do istniejącego pokoju
  async function joinExistingRoom() {
    if (!currentUser) return alert('Zaloguj się najpierw');

    const roomId = document.getElementById('roomIdInput').value.trim().toUpperCase();
    if (!roomId) return alert('Wpisz ID pokoju');

    const roomRef = db.collection('rooms').doc(roomId);
    const roomSnap = await roomRef.get();

    if (!roomSnap.exists) return alert('Pokój nie istnieje');

    if (roomSnap.data().started) return alert('Gra już się rozpoczęła!');

    currentRoomId = roomId;
    isHost = false;

    await roomRef.collection('players').doc(currentUser.uid).set({
      nick: currentUser.nick,
      joinedAt: Date.now()
    });

    openRoom(roomId);
  }

  // Otwórz pokój - pokazujemy UI i nasłuchujemy zmian
  function openRoom(roomId) {
    document.getElementById('lobbySection').style.display = 'none';
    document.getElementById('gameSection').style.display = 'block';
    document.getElementById('roomIdDisplay').textContent = roomId;

    if (isHost) {
      document.getElementById('startGameBtn').style.display = 'inline-block';
    }

    listenForPlayers(roomId);
    listenForGameStart(roomId);
  }

  // Nasłuchiwanie graczy i aktualizacja listy
  function listenForPlayers(roomId) {
    const playersListEl = document.getElementById('playersList');
    const playersCountEl = document.getElementById('playersCount');
    const playersRef = db.collection('rooms').doc(roomId).collection('players');

    playersRef.onSnapshot(snapshot => {
      playersListEl.innerHTML = '';
      snapshot.docs.forEach(doc => {
        const p = document.createElement('li');
        p.textContent = doc.data().nick;
        playersListEl.appendChild(p);
      });
      playersCountEl.textContent = snapshot.size;
    });
  }

  // Nasłuchiwanie startu gry i słowa
  function listenForGameStart(roomId) {
    const roomRef = db.collection('rooms').doc(roomId);
    const playerDocRef = roomRef.collection('players').doc(currentUser.uid);

    roomRef.onSnapshot(async doc => {
      if (!doc.exists) return;

      const data = doc.data();
      if (data.started) {
        // Gra wystartowała, pobierz słowo dla siebie
        const playerDoc = await playerDocRef.get();
        if (playerDoc.exists) {
          const word = playerDoc.data().word;
          document.getElementById('wordDisplay').textContent = `Twoje słowo to: ${word}`;
          document.getElementById('startGameBtn').style.display = 'none';
        }
      }
    });
  }

  // Start gry - losowanie szpiega i słów
  async function startGame() {
    if (!isHost) return alert('Tylko host może rozpocząć grę!');
    if (!currentRoomId) return alert('Brak pokoju');

    const roomRef = db.collection('rooms').doc(currentRoomId);
    const playersSnap = await roomRef.collection('players').get();
    if (playersSnap.size < 3) return alert('Potrzeba co najmniej 3 graczy!');

    const players = playersSnap.docs;
    const wordPairs = [
      ['pizza', 'kot'],
      ['rower', 'hulajnoga'],
      ['kawa', 'herbata'],
      ['morze', 'jezioro'],
      ['książka', 'gazeta']
    ];

    const pair = wordPairs[Math.floor(Math.random() * wordPairs.length)];
    const spyIndex = Math.floor(Math.random() * players.length);

    const batch = db.batch();
    players.forEach((doc, idx) => {
      const word = (idx === spyIndex) ? pair[1] : pair[0];
      batch.update(doc.ref, { word });
    });
    batch.update(roomRef, { started: true });
    await batch.commit();
  }

</script>
</body>
</html>
